<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸµ Web DJ Pad ğŸµ</title>
  <style>
    /* åŸºç¤è¨­å®š */
    body {
      background: #1a1a2e; 
      color: #fff; 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0;
      user-select: none; 
      -webkit-user-select: none;
      overscroll-behavior: none;
    }

    h1 {text-align: center; color: #00d4ff; margin-top: 32px; font-weight: 700;}
    
    .panel {display: flex; justify-content: center; flex-wrap: wrap; gap: 24px; margin: 24px 0; padding: 0 10px;}
    .panel label {display:inline-flex; align-items:center; gap:8px; font-size: 1.1rem;}
    
    .grid {
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 16px; 
      max-width: 600px; 
      margin: 0 auto; 
      padding: 10px;
    }

    .pad {
      background: linear-gradient(145deg, #2a2a3a, #1a1a2a); 
      border-radius: 16px; 
      aspect-ratio: 1/1;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      font-size: 1.5rem; 
      box-shadow: 0 6px 15px rgba(0,0,0,0.4); 
      transition: transform 0.1s, background 0.1s, box-shadow 0.1s;
      position: relative;
      overflow: hidden;
      touch-action: none; 
      -webkit-tap-highlight-color: transparent;
    }

    .pad:active { transform: scale(0.92); }
    
    .pad.active {
      background: linear-gradient(145deg, #00d4ff, #ff4081); 
      transform: scale(0.95);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
      color: #fff;
    }

    .pad.error {
      background: linear-gradient(145deg, #ff4444, #cc0000);
      animation: shake 0.3s ease-in-out;
    }

    .pad strong { font-size: 1.8rem; pointer-events: none; }
    .pad-label { 
      font-size: 0.9rem; 
      margin-top: 6px; 
      opacity: 0.8; 
      pointer-events: none; 
      text-align: center;
      padding: 0 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .mode-btn {
      padding: 8px 16px; 
      border: 1px solid #444; 
      border-radius: 20px; 
      margin: 0 4px; 
      cursor: pointer; 
      background: #222; 
      color: #aaa;
      transition: all 0.2s;
    }
    .mode-btn:hover { background: #333; }
    .mode-btn.active {
      background: linear-gradient(45deg, #00d4ff, #ff4081); 
      color: #fff; 
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
    }

    .volume-slider { width: 120px; accent-color: #00d4ff; cursor: pointer; }
    
    .loading { text-align: center; margin: 20px; color: #00d4ff; font-weight: bold; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    @media (max-width: 500px) {
      .grid { gap: 10px; }
      .pad strong { font-size: 1.4rem; }
      .pad-label { font-size: 0.75rem; }
    }
  </style>
</head>
<body>

  <h1>ğŸµ Web DJ Pad ğŸµ</h1>
  
  <div class="panel">
    <label>ğŸ”Š éŸ³é‡ <input type="range" id="volume" class="volume-slider" min="0" max="100" value="80"></label>
    <label>æ¨¡å¼
      <button class="mode-btn active" data-mode="normal">æ¨™æº–</button>
      <button class="mode-btn" data-mode="loop">å¾ªç’°</button>
      <button class="mode-btn" data-mode="oneshot">å–®æ¬¡</button>
    </label>
  </div>

  <div id="loading" class="loading">æ­£åœ¨é è¼‰å…¥éŸ³æ•ˆ...</div>
  
  <div class="grid" id="padGrid"></div>

  <script>
    // --- é…ç½®å¸¸æ•¸ ---
    const PAD_KEYS = ["1","2","3","4","A","C","D","E","F","Q","R","S","V","W","X","Z"];
    const SOUND_FILES = [
      "1_è¦ªæ„›çš„.mp3", "2_ç¤ºæ„åœè»Š.mp3", "3_å»æ´ªå¹¹å¹¹æ¬¸.mp3", "4_DAMN.mp3",
      "A_For Elise(Oiiai).mp3", "C_Dj Airhorn.mp3", "D_æ˜ŸæœŸäº”æ™šä¸Š.mp3", "E_é»‘é»‘é»‘é»‘.mp3",
      "F_è«‹æ”¯æ´æ”¶éŠ€.mp3", "Q_John Cena.mp3", "R_é˜¿çæ„›ä¸Šäº†é˜¿å¼·.mp3", "S_Young Black&Rich.mp3",
      "V_å‰æ–¹è»Šè¼›è«‹å‘å³é¿è®“.mp3", "W_ç‹è€å…ˆç”Ÿæœ‰å¡Šåœ°.mp3", "X_Airhorn.mp3", "Z_æ–°å¹¹ç·šã‚¨ã‚¢ãƒ›ãƒ¼ãƒ³.mp3"
    ];
    const AUDIO_PATH = "audio/";

    // --- å…¨åŸŸç‹€æ…‹ ---
    let playMode = "normal";
    let volume = 0.8;
    const activeAudios = {};
    const preloadedAudios = {};
    const padElements = {};
    const pressedKeys = new Set();

    // --- å·¥å…·å‡½æ•¸ ---
    function getPadLabel(fname) {
      const match = fname.match(/_(.+)\.\w+$/);
      return match ? match[1] : fname.replace(/\.\w+$/, '');
    }

    // [å„ªåŒ–] ä½¿ç”¨å¯é¸éˆç¢ºä¿æœ€å¤§ç›¸å®¹æ€§
    function safeSetPointerCapture(element, pointerId) {
      try {
        if (element.hasPointerCapture?.(pointerId)) return;
        element.setPointerCapture?.(pointerId);
      } catch (e) {
        // éœé»˜è™•ç†ç•°å¸¸
      }
    }

    function safeReleasePointerCapture(element, pointerId) {
      try {
        if (!element.hasPointerCapture?.(pointerId)) return;
        element.releasePointerCapture?.(pointerId);
      } catch (e) {
        // éœé»˜è™•ç†ç•°å¸¸
      }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šé è¼‰å…¥éŸ³é » ---
    async function preloadAudios() {
      const loadingEl = document.getElementById('loading');
      let loadedCount = 0;
      const total = SOUND_FILES.length;

      const promises = SOUND_FILES.map((file, idx) => {
        return new Promise((resolve) => {
          const key = PAD_KEYS[idx];
          const audio = new Audio();
          
          const handleLoad = () => {
            preloadedAudios[key] = audio;
            updateProgress();
            resolve();
          };

          const handleError = () => {
            console.warn(`âš ï¸ ç„¡æ³•è¼‰å…¥éŸ³é »: ${file}`);
            updateProgress();
            resolve();
          };

          audio.addEventListener('canplaythrough', handleLoad, { once: true });
          audio.addEventListener('error', handleError, { once: true });

          audio.src = AUDIO_PATH + file;
          audio.preload = 'auto';
          audio.load();
        });
      });

      function updateProgress() {
        loadedCount++;
        loadingEl.textContent = `è¼‰å…¥ä¸­... ${Math.floor((loadedCount / total) * 100)}%`;
      }

      await Promise.all(promises);
      loadingEl.style.display = 'none';
      console.log("âœ… éŸ³æ•ˆè¼‰å…¥å®Œæˆ");
    }

    // --- æ’­æ”¾é‚è¼¯ ---
    function playPad(key) {
      const pad = padElements[key];
      if (!pad) return;

      if (!preloadedAudios[key]) {
        console.error(`âŒ éŸ³é » ${key} æœªå°±ç·’æˆ–æª”æ¡ˆéºå¤±`);
        triggerVisualError(pad);
        return;
      }

      if (playMode === "oneshot") {
        stopAllPads();
      }

      if (playMode === "loop" && activeAudios[key]) {
        stopPad(key);
        return;
      }

      stopPad(key);

      const sourceAudio = preloadedAudios[key];
      const audio = sourceAudio.cloneNode();
      audio.volume = volume;
      audio.loop = (playMode === "loop");

      audio.onended = () => {
        pad.classList.remove('active');
        delete activeAudios[key];
      };

      // å…ˆè¨»å†Šç‹€æ…‹ï¼Œç¢ºä¿åœæ­¢åŠŸèƒ½ä¸æœƒéºæ¼
      activeAudios[key] = audio;
      pad.classList.add('active');

      // æ’­æ”¾ä¸¦è™•ç†å¯èƒ½çš„å¤±æ•—
      const playPromise = audio.play();
      if (playPromise !== undefined) {
        playPromise.catch(err => {
          console.error(`âŒ æ’­æ”¾å¤±æ•—: ${key}`, err);
          pad.classList.remove('active');
          delete activeAudios[key];
          triggerVisualError(pad);
        });
      }
    }

    function stopPad(key) {
      const audio = activeAudios[key];
      if (audio) {
        audio.pause();
        audio.currentTime = 0;
        delete activeAudios[key];
      }
      padElements[key]?.classList.remove('active');
    }

    function stopAllPads() {
      Object.keys(activeAudios).forEach(stopPad);
    }

    function triggerVisualError(pad) {
      pad.classList.add('error');
      setTimeout(() => pad.classList.remove('error'), 300);
    }

    // --- UI åˆå§‹åŒ–èˆ‡äº‹ä»¶ ---
    const padGrid = document.getElementById('padGrid');
    
    PAD_KEYS.forEach((key, idx) => {
      const fname = SOUND_FILES[idx];
      const pad = document.createElement('div');
      
      pad.className = "pad";
      pad.innerHTML = `<strong>${key}</strong><div class="pad-label">${getPadLabel(fname)}</div>`;
      pad.setAttribute('role', 'button');
      pad.setAttribute('aria-label', `æ’­æ”¾éŸ³æ•ˆ ${key}`);
      pad.tabIndex = 0;

      pad.onpointerdown = (e) => {
        e.preventDefault();
        safeSetPointerCapture(pad, e.pointerId);
        playPad(key);
      };

      pad.onpointerup = (e) => {
        safeReleasePointerCapture(pad, e.pointerId);
      };

      pad.onpointercancel = (e) => {
        safeReleasePointerCapture(pad, e.pointerId);
      };

      padGrid.appendChild(pad);
      padElements[key] = pad;
    });

    // --- æ§åˆ¶é¢æ¿äº‹ä»¶ ---
    document.getElementById('volume').oninput = (e) => {
      volume = e.target.value / 100;
      Object.values(activeAudios).forEach(audio => audio.volume = volume);
    };

    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        playMode = btn.dataset.mode;
        if (playMode === 'oneshot') stopAllPads();
      };
    });

    // --- éµç›¤äº‹ä»¶ ---
    document.addEventListener('keydown', (e) => {
      if (e.isComposing || e.keyCode === 229) return;
      if (["INPUT", "TEXTAREA"].includes(e.target.tagName)) return;

      const key = e.key.toUpperCase();

      if (pressedKeys.has(key)) return;
      pressedKeys.add(key);

      if (PAD_KEYS.includes(key)) {
        e.preventDefault();
        if (e.ctrlKey || e.metaKey) {
          stopPad(key);
        } else {
          playPad(key);
        }
      } else if (e.code === "Space") {
        e.preventDefault();
        stopAllPads();
      }
    });

    document.addEventListener('keyup', (e) => {
      const key = e.key.toUpperCase();
      pressedKeys.delete(key);
    });

    window.addEventListener('blur', () => {
      pressedKeys.clear();
    });

    // å•Ÿå‹•
    preloadAudios();
  </script>
</body>
</html>
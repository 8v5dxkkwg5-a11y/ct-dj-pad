<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸµ Web DJ Pad ğŸµ</title>
  <style>
    /* --- 1. åŸºç¤è¨­å®š --- */
    body {
      background: #121220; 
      color: #fff; 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0;
      user-select: none; 
      -webkit-user-select: none;
      overscroll-behavior: none;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    h1 {
      text-align: center; 
      color: #00d4ff; 
      margin: 15px 0 10px 0; 
      font-weight: 800;
      font-size: 1.8rem;
      text-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
      z-index: 10;
    }

    /* --- 2. å•Ÿå‹•é®ç½© --- */
    #startOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(18, 18, 32, 0.98);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 9999; 
      transition: opacity 0.5s;
    }
    #startOverlay h2 { color: #00d4ff; margin-bottom: 30px; font-size: 2rem; }
    .start-btn {
      padding: 15px 50px; border-radius: 50px; border: none;
      background: linear-gradient(45deg, #00d4ff, #ff4081);
      color: #fff; font-size: 1.2rem; font-weight: bold;
      box-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
      cursor: pointer;
      animation: pulse 2s infinite;
      transition: transform 0.2s;
    }
    .start-btn:active { transform: scale(0.95); }

    /* --- 3. æ§åˆ¶é¢æ¿ (é‡æ§‹ç‰ˆ) --- */
    .panel {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      margin: 0 10px 10px 10px;
      border-radius: 16px;
      display: flex; 
      flex-direction: column;
      gap: 15px; 
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.05);
      z-index: 10;
    }

    /* æ§åˆ¶å€å¡Šå®¹å™¨ */
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    .control-block {
      background: rgba(0, 0, 0, 0.2);
      padding: 10px 15px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-width: 280px;
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: #ccc;
      font-weight: 600;
    }

    /* æ•¸å€¼é¡¯ç¤ºèˆ‡å¾®èª¿å€ */
    .value-adjuster {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* è¼¸å…¥æ¡†æ¨£å¼ */
    .val-input {
      background: #222;
      border: 1px solid #444;
      color: #00d4ff;
      width: 50px;
      text-align: center;
      border-radius: 4px;
      padding: 2px 4px;
      font-weight: bold;
      font-size: 0.9rem;
    }
    .val-input:focus { outline: none; border-color: #00d4ff; }

    /* å¾®èª¿æŒ‰éˆ• (+/-) */
    .adj-btn {
      width: 24px; height: 24px;
      border-radius: 4px; border: 1px solid #444;
      background: #333; color: #fff;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 1rem; line-height: 1;
      transition: background 0.1s;
    }
    .adj-btn:hover { background: #444; border-color: #00d4ff; }
    .adj-btn:active { transform: scale(0.95); }

    /* æ»‘æ¡¿æ¨£å¼ */
    input[type=range] {
      -webkit-appearance: none; width: 100%; height: 6px;
      background: #444; border-radius: 3px; outline: none;
      margin: 5px 0;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px;
      border-radius: 50%; background: #00d4ff; cursor: pointer;
      transition: transform 0.1s; box-shadow: 0 0 10px rgba(0,212,255,0.5);
    }
    input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }

    /* å¿«æ·æŒ‰éˆ•å€ */
    .presets {
      display: flex;
      gap: 6px;
      justify-content: space-between;
    }
    .preset-btn {
      flex: 1;
      padding: 4px 0;
      font-size: 0.75rem;
      background: rgba(255,255,255,0.1);
      border: 1px solid transparent;
      border-radius: 6px;
      color: #aaa;
      cursor: pointer;
      transition: all 0.2s;
    }
    .preset-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
    .preset-btn:active { background: #00d4ff; color: #000; }
    
    /* æ¨¡å¼æŒ‰éˆ• */
    .mode-container {
      display: flex; justify-content: center; gap: 10px; margin-top: 5px;
    }
    .mode-btn {
      padding: 8px 20px; border: 1px solid #444; border-radius: 20px;
      cursor: pointer; background: #222; color: #aaa; font-size: 0.9rem;
      transition: all 0.2s; flex: 1; max-width: 100px; text-align: center;
    }
    .mode-btn:hover { background: #333; color: #fff; }
    .mode-btn.active {
      background: linear-gradient(135deg, #00d4ff, #005bea);
      color: #fff; border-color: transparent;
      box-shadow: 0 4px 12px rgba(0, 91, 234, 0.4);
    }

    /* --- 4. Pad ç¶²æ ¼ä½ˆå±€ --- */
    .grid-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 10px 20px 10px;
      width: 100%;
      box-sizing: border-box;
    }

    .grid {
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 12px; 
      width: 100%;
      max-width: 600px; 
      aspect-ratio: 1/1;
    }

    /* --- 5. Pad æœ¬é«”æ¨£å¼ --- */
    .pad {
      background: linear-gradient(145deg, #2a2a3a, #1a1a25); 
      border-radius: 12px; 
      display: flex; flex-direction: column; align-items: center; justify-content: center; 
      cursor: pointer; position: relative; overflow: hidden;
      touch-action: none; -webkit-tap-highlight-color: transparent;
      box-shadow: inset 0 1px 1px rgba(255,255,255,0.1), 0 6px 15px rgba(0,0,0,0.4);
      transition: transform 0.05s, box-shadow 0.1s, border-color 0.2s;
      border: 2px solid transparent;
    }

    /* äº’å‹•ç‹€æ…‹ */
    .pad:active { transform: scale(0.96); }
    .pad.active {
      background: linear-gradient(145deg, #00d4ff, #ff0055); 
      box-shadow: 0 0 25px rgba(0, 212, 255, 0.6);
      border-color: rgba(255,255,255,0.5);
    }
    .pad.drag-over { border-color: #00d4ff; background: #333; transform: scale(1.02); }
    .pad.error {
      background: linear-gradient(145deg, #ff4444, #cc0000);
      animation: shake 0.3s ease-in-out;
    }

    /* Pad å…§å®¹ */
    .pad strong { 
      font-size: 1.8rem; pointer-events: none; z-index: 2;
      color: rgba(255,255,255,0.8); text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .pad-label { 
      font-size: 0.8rem; margin-top: 4px; z-index: 2;
      color: rgba(255,255,255,0.5); pointer-events: none; 
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%;
    }
    .pad.active strong, .pad.active .pad-label { color: #fff; }

    /* é€²åº¦æ¢ */
    .progress-bar {
      position: absolute; bottom: 0; left: 0; height: 5px;
      background: #fff; width: 0%; opacity: 0;
      transition: opacity 0.1s; pointer-events: none;
      box-shadow: 0 0 10px rgba(255,255,255,0.8);
      z-index: 1;
    }
    .pad.active .progress-bar { opacity: 1; }

    /* --- å…¶ä»– --- */
    .loading { text-align: center; margin: 10px; color: #00d4ff; font-weight: bold; font-size: 0.9rem; }
    .hint { 
      text-align: center; font-size: 0.8rem; color: #666; 
      margin-bottom: 10px; pointer-events: none; 
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(0, 212, 255, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 212, 255, 0); }
    }

    @media (max-width: 600px) {
      .grid { gap: 8px; }
      .pad strong { font-size: 1.4rem; }
      .pad-label { font-size: 0.7rem; }
      .control-block { min-width: 100%; }
    }
  </style>
</head>
<body>

  <div id="startOverlay">
    <h2>ğŸµ Web DJ Pad ğŸµ</h2>
    <button class="start-btn">é»æ“Šé–‹å§‹ / Click to Start</button>
    <p style="margin-top:20px; opacity:0.6; font-size:0.9rem; color:#aaa;">æ”¯æ´å¤šé‡éŸ³æ•ˆç–ŠåŠ  (Polyphony Mode)</p>
  </div>

  <h1>ğŸµ Web DJ Pad ğŸµ</h1>
  
  <div class="panel">
    
    <div class="controls-row">
      <div class="control-block">
        <div class="block-header">
          <span>ğŸ”Š éŸ³é‡ (Volume)</span>
          <div class="value-adjuster">
            <input type="number" id="vol-input" class="val-input" min="0" max="100" value="80">
            <span>%</span>
          </div>
        </div>
        <input type="range" id="volume" min="0" max="100" value="80">
        <div class="presets">
          <button class="preset-btn" onclick="updateVolume(0)">Mute</button>
          <button class="preset-btn" onclick="updateVolume(30)">30%</button>
          <button class="preset-btn" onclick="updateVolume(50)">50%</button>
          <button class="preset-btn" onclick="updateVolume(80)">80%</button>
          <button class="preset-btn" onclick="updateVolume(100)">100%</button>
        </div>
      </div>

      <div class="control-block">
        <div class="block-header">
          <span>ğŸš€ é€Ÿåº¦ (Speed)</span>
          <div class="value-adjuster">
            <button class="adj-btn" onclick="adjustPitch(-0.1)">-</button>
            <span id="pitch-val" style="min-width: 40px; text-align: center; color:#00d4ff; font-weight:bold;">1.0x</span>
            <button class="adj-btn" onclick="adjustPitch(0.1)">+</button>
          </div>
        </div>
        <input type="range" id="pitch" min="0.5" max="2.0" step="0.1" value="1.0">
        <div class="presets">
          <button class="preset-btn" onclick="updatePitch(0.5)">0.5x</button>
          <button class="preset-btn" onclick="updatePitch(0.8)">0.8x</button>
          <button class="preset-btn" onclick="updatePitch(1.0)">1.0x</button>
          <button class="preset-btn" onclick="updatePitch(1.2)">1.2x</button>
          <button class="preset-btn" onclick="updatePitch(1.5)">1.5x</button>
          <button class="preset-btn" onclick="updatePitch(2.0)">2.0x</button>
        </div>
      </div>
    </div>

    <div class="mode-container">
      <button class="mode-btn active" data-mode="normal">æ¨™æº–</button>
      <button class="mode-btn" data-mode="loop">å¾ªç’°</button>
      <button class="mode-btn" data-mode="oneshot">å–®æ¬¡</button>
    </div>

  </div>

  <div id="loading" class="loading">æ­£åœ¨é è¼‰å…¥éŸ³æ•ˆ...</div>
  
  <div class="grid-container">
    <div class="grid" id="padGrid"></div>
  </div>
  
  <div class="hint">ğŸ’¡ æç¤ºï¼šæ”¯æ´é€£çºŒé»æ“Šæ’­æ”¾ (Polyphony)</div>

  <script>
    // --- é…ç½®å¸¸æ•¸ ---
    const PAD_KEYS = ["1","2","3","4","A","C","D","E","F","Q","R","S","V","W","X","Z"];
    const DEFAULT_FILES = [
      "1_è¦ªæ„›çš„.mp3", "2_ç¤ºæ„åœè»Š.mp3", "3_å»æ´ªå¹¹å¹¹æ¬¸.mp3", "4_DAMN.mp3",
      "A_For Elise(Oiiai).mp3", "C_Dj Airhorn.mp3", "D_æ˜ŸæœŸäº”æ™šä¸Š.mp3", "E_é»‘é»‘é»‘é»‘.mp3",
      "F_è«‹æ”¯æ´æ”¶éŠ€.mp3", "Q_John Cena.mp3", "R_é˜¿çæ„›ä¸Šäº†é˜¿å¼·.mp3", "S_Young Black&Rich.mp3",
      "V_å‰æ–¹è»Šè¼›è«‹å‘å³é¿è®“.mp3", "W_ç‹è€å…ˆç”Ÿæœ‰å¡Šåœ°.mp3", "X_Airhorn.mp3", "Z_æ–°å¹¹ç·šã‚¨ã‚¢ãƒ›ãƒ¼ãƒ³.mp3"
    ];
    const AUDIO_PATH = "audio/";

    // --- å…¨åŸŸç‹€æ…‹ ---
    let appState = {
      mode: "normal",
      volume: 0.8,
      playbackRate: 1.0
    };
    let isInitialized = false;
    let saveSettingsTimer = null;

    const activeAudios = {}; 
    const runningSounds = new Set();
    
    const preloadedAudios = {};
    const padElements = {};
    const pressedKeys = new Set();
    const progressAnimationIds = {};
    const blobUrls = {};

    // --- å·¥å…·å‡½æ•¸ ---
    function getPadLabel(fname) {
      if (!fname) return "Empty";
      try { fname = decodeURIComponent(fname); } catch(e){}
      const match = fname.match(/_(.+)\.\w+$/);
      return match ? match[1] : fname.replace(/\.\w+$/, '');
    }

    function safeSetPointerCapture(el, id) {
      try { if(el.hasPointerCapture?.(id)) return; el.setPointerCapture?.(id); } catch(e){}
    }
    function safeReleasePointerCapture(el, id) {
      try { if(!el.hasPointerCapture?.(id)) return; el.releasePointerCapture?.(id); } catch(e){}
    }

    // --- 1. è¨­å®šç®¡ç† (LocalStorage) ---
    function loadSettings() {
      const saved = localStorage.getItem('djPadSettingsPro');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          appState = { ...appState, ...parsed }; 
          
          updateUIControls(); // çµ±ä¸€æ›´æ–° UI
          
          document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === appState.mode);
          });
        } catch(e) { console.error("è¨­å®šè®€å–å¤±æ•—", e); }
      }
    }

    function saveSettings() {
      clearTimeout(saveSettingsTimer);
      saveSettingsTimer = setTimeout(() => {
        localStorage.setItem('djPadSettingsPro', JSON.stringify(appState));
      }, 300);
    }

    // --- 2. æ ¸å¿ƒï¼šé è¼‰å…¥éŸ³é » ---
    async function preloadAudios() {
      const loadingEl = document.getElementById('loading');
      let loadedCount = 0;
      const total = DEFAULT_FILES.length;

      const promises = DEFAULT_FILES.map((file, idx) => {
        return new Promise((resolve) => {
          const key = PAD_KEYS[idx];
          const audio = new Audio();
            
          const done = () => {
            loadedCount++;
            loadingEl.textContent = `è¼‰å…¥ä¸­... ${Math.floor((loadedCount / total) * 100)}%`;
            resolve();
          };

          audio.oncanplaythrough = () => { preloadedAudios[key] = audio; done(); };
          audio.onerror = () => { 
            console.warn(`âš ï¸ ç¼ºæª”: ${file}`);
            preloadedAudios[key] = null;
            done(); 
          };

          audio.src = AUDIO_PATH + file;
          audio.preload = 'auto';
          audio.load();
        });
      });

      await Promise.all(promises);
      loadingEl.style.display = 'none';
    }

    // --- 3. ç¨ç«‹å‹•ç•«æ§åˆ¶ ---
    function startProgressAnimation(key, audioInstance) {
      if (progressAnimationIds[key]) {
        cancelAnimationFrame(progressAnimationIds[key]);
      }

      const pad = padElements[key];
      const progressBar = pad.querySelector('.progress-bar');

      const update = () => {
        if (activeAudios[key] !== audioInstance) return;

        if (audioInstance.duration && Number.isFinite(audioInstance.duration)) {
          const pct = (audioInstance.currentTime / audioInstance.duration) * 100;
          progressBar.style.width = `${pct}%`;
        }

        if (!audioInstance.paused && !audioInstance.ended) {
          progressAnimationIds[key] = requestAnimationFrame(update);
        }
      };

      progressAnimationIds[key] = requestAnimationFrame(update);
    }

    // --- 4. æ’­æ”¾é‚è¼¯ ---
    function playPad(key) {
      if (!isInitialized) return;

      const pad = padElements[key];
      if (!pad) return;

      if (!preloadedAudios[key]) {
        triggerVisualError(pad);
        return;
      }

      if (appState.mode === "oneshot") {
        stopAllPads(); 
      } else if (appState.mode === "loop") {
        if (activeAudios[key]) {
          stopPad(key); 
          return;
        }
      } 

      const sourceAudio = preloadedAudios[key];
      if (!sourceAudio || !sourceAudio.src) { triggerVisualError(pad); return; }

      const audio = sourceAudio.cloneNode();
      audio.volume = appState.volume;
      audio.playbackRate = appState.playbackRate;
      audio.loop = (appState.mode === "loop");
      audio._padKey = key;

      runningSounds.add(audio);

      audio.onended = () => {
        runningSounds.delete(audio);
        const remainingSounds = [...runningSounds].filter(a => a._padKey === key);

        if (activeAudios[key] === audio) {
          if (remainingSounds.length > 0) {
            const nextAudio = remainingSounds[remainingSounds.length - 1];
            activeAudios[key] = nextAudio;
            startProgressAnimation(key, nextAudio);
          } else {
            delete activeAudios[key];
            pad.classList.remove('active');
            pad.querySelector('.progress-bar').style.width = '0%';
            if (progressAnimationIds[key]) cancelAnimationFrame(progressAnimationIds[key]);
          }
        } else if (remainingSounds.length === 0) {
           pad.classList.remove('active');
           pad.querySelector('.progress-bar').style.width = '0%';
           delete activeAudios[key];
        }
      };

      activeAudios[key] = audio;
      pad.classList.add('active');

      const playPromise = audio.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            if (activeAudios[key] === audio) {
              startProgressAnimation(key, audio);
            }
          })
          .catch(err => {
            console.error(`æ’­æ”¾å¤±æ•—: ${key}`, err);
            runningSounds.delete(audio);
            if (activeAudios[key] === audio) {
              pad.classList.remove('active');
              delete activeAudios[key];
              triggerVisualError(pad);
            }
          });
      }
    }

    function stopPad(key) {
      runningSounds.forEach(audio => {
        if (audio._padKey === key) {
          audio.pause();
          audio.currentTime = 0;
          runningSounds.delete(audio);
        }
      });
      
      if (progressAnimationIds[key]) {
        cancelAnimationFrame(progressAnimationIds[key]);
        delete progressAnimationIds[key];
      }
      
      const pad = padElements[key];
      if (pad) {
        pad.classList.remove('active');
        pad.querySelector('.progress-bar').style.width = '0%';
      }
      delete activeAudios[key];
    }

    function stopAllPads() {
      runningSounds.forEach(audio => {
        audio.pause();
        audio.currentTime = 0;
      });
      runningSounds.clear();
      
      Object.keys(padElements).forEach(key => {
        const pad = padElements[key];
        if (pad) {
          pad.classList.remove('active');
          pad.querySelector('.progress-bar').style.width = '0%';
        }
        if (progressAnimationIds[key]) cancelAnimationFrame(progressAnimationIds[key]);
      });
      
      for (const key in activeAudios) delete activeAudios[key];
    }

    function triggerVisualError(pad) {
      pad.classList.add('error');
      setTimeout(() => pad.classList.remove('error'), 300);
    }

    // --- 5. Drag & Drop ---
    function setupDragAndDrop(pad, key) {
      pad.ondragover = (e) => { e.preventDefault(); pad.classList.add('drag-over'); };
      pad.ondragleave = (e) => { e.preventDefault(); pad.classList.remove('drag-over'); };

      pad.ondrop = (e) => {
        e.preventDefault();
        pad.classList.remove('drag-over');

        const file = e.dataTransfer.files[0];
        if (file && (file.type.startsWith('audio/') || file.name.match(/\.(mp3|wav|ogg|m4a)$/i))) {
          if (blobUrls[key]) {
            URL.revokeObjectURL(blobUrls[key]);
            delete blobUrls[key];
          }

          const objectUrl = URL.createObjectURL(file);
          blobUrls[key] = objectUrl;
          
          const newAudio = new Audio(objectUrl);
          newAudio.preload = 'auto';
          
          preloadedAudios[key] = newAudio;
          
          const labelEl = pad.querySelector('.pad-label');
          labelEl.textContent = file.name.replace(/\.\w+$/, '');
          labelEl.style.color = "#00d4ff";
          
          pad.style.borderColor = "#00d4ff";
          setTimeout(() => pad.style.borderColor = "transparent", 500);
        } else {
          triggerVisualError(pad);
        }
      };
    }

    // --- 6. DOM åˆå§‹åŒ– ---
    const padGrid = document.getElementById('padGrid');
    
    PAD_KEYS.forEach((key, idx) => {
      const fname = DEFAULT_FILES[idx];
      const pad = document.createElement('div');
      
      pad.className = "pad";
      pad.innerHTML = `
        <strong>${key}</strong>
        <div class="pad-label">${getPadLabel(fname)}</div>
        <div class="progress-bar"></div>
      `;
      
      pad.setAttribute('role', 'button');
      pad.setAttribute('aria-label', `æ’­æ”¾ ${key}`);
      pad.tabIndex = 0;

      pad.onpointerdown = (e) => {
        e.preventDefault();
        safeSetPointerCapture(pad, e.pointerId);
        playPad(key);
      };
      pad.onpointerup = (e) => safeReleasePointerCapture(pad, e.pointerId);
      pad.onpointercancel = (e) => safeReleasePointerCapture(pad, e.pointerId);

      setupDragAndDrop(pad, key);

      padGrid.appendChild(pad);
      padElements[key] = pad;
    });

    // --- 7. UI æ§åˆ¶èˆ‡äº‹ä»¶ç›£è½ ---
    
    // æ›´æ–°éŸ³é‡ (æ•´åˆ Slider, Input, Presets)
    function updateVolume(val) {
      let v = parseInt(val);
      if (isNaN(v)) v = 80;
      if (v < 0) v = 0;
      if (v > 100) v = 100;
      
      appState.volume = v / 100;
      
      document.getElementById('volume').value = v;
      document.getElementById('vol-input').value = v;
      
      runningSounds.forEach(audio => audio.volume = appState.volume);
      saveSettings();
    }

    // æ›´æ–°é€Ÿåº¦ (æ•´åˆ Slider, Presets)
    function updatePitch(val) {
      let p = parseFloat(val);
      if (isNaN(p)) p = 1.0;
      if (p < 0.5) p = 0.5;
      if (p > 2.0) p = 2.0;
      
      p = parseFloat(p.toFixed(1));

      appState.playbackRate = p;
      
      document.getElementById('pitch').value = p;
      document.getElementById('pitch-val').textContent = p + "x";
      
      runningSounds.forEach(audio => audio.playbackRate = appState.playbackRate);
      saveSettings();
    }

    // å¾®èª¿é€Ÿåº¦ (+/- æŒ‰éˆ•)
    function adjustPitch(delta) {
      let newPitch = appState.playbackRate + delta;
      updatePitch(newPitch);
    }

    // æ›´æ–° UI é¡¯ç¤º (å¾ AppState åŒæ­¥)
    function updateUIControls() {
      document.getElementById('volume').value = appState.volume * 100;
      document.getElementById('vol-input').value = Math.round(appState.volume * 100);
      
      document.getElementById('pitch').value = appState.playbackRate;
      document.getElementById('pitch-val').textContent = appState.playbackRate + "x";
    }

    // ç¶å®š Slider äº‹ä»¶
    document.getElementById('volume').oninput = (e) => updateVolume(e.target.value);
    document.getElementById('vol-input').onchange = (e) => updateVolume(e.target.value);
    
    document.getElementById('pitch').oninput = (e) => updatePitch(e.target.value);

    // ã€é—œéµä¿®æ­£ã€‘æ¨¡å¼åˆ‡æ› - è™•ç†å¾ªç’°éŸ³é »
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.onclick = () => {
        const oldMode = appState.mode;
        
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        appState.mode = btn.dataset.mode;
        
        // å¦‚æœå¾å¾ªç’°æ¨¡å¼åˆ‡æ›å‡ºå»ï¼Œåœæ­¢æ‰€æœ‰æ­£åœ¨å¾ªç’°çš„éŸ³é »
        if (oldMode === 'loop' && appState.mode !== 'loop') {
          stopAllPads();
        }
        
        // åˆ‡æ›åˆ°å–®æ¬¡æ¨¡å¼ä¹Ÿåœæ­¢æ‰€æœ‰éŸ³é »
        if (appState.mode === 'oneshot') {
          stopAllPads();
        }
        
        saveSettings();
      };
    });

    // éµç›¤æ§åˆ¶
    document.addEventListener('keydown', (e) => {
      if (!isInitialized) return;
      if (e.isComposing || e.keyCode === 229) return;
      if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;

      const key = e.key.toUpperCase();
      if (pressedKeys.has(key)) return;
      pressedKeys.add(key);

      if (PAD_KEYS.includes(key)) {
        e.preventDefault();
        (e.ctrlKey || e.metaKey) ? stopPad(key) : playPad(key);
      } else if (e.code === "Space") {
        e.preventDefault();
        stopAllPads();
      }
    });

    document.addEventListener('keyup', (e) => pressedKeys.delete(e.key.toUpperCase()));
    window.addEventListener('blur', () => pressedKeys.clear());

    window.addEventListener('beforeunload', () => {
      Object.values(blobUrls).forEach(url => URL.revokeObjectURL(url));
    });

    // --- 8. å•Ÿå‹•ç¨‹åº ---
    const overlay = document.getElementById('startOverlay');
    const startBtn = document.querySelector('.start-btn');
    
    startBtn.onclick = () => {
      isInitialized = true;
      overlay.style.opacity = '0';
      setTimeout(() => overlay.style.display = 'none', 500);
      
      const silentAudio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
      silentAudio.play().then(() => {
        console.log("âœ… éŸ³é »ç³»çµ±å·²è§£é–");
      }).catch(e => {
        console.warn("âš ï¸ éŸ³é »è§£é–å¤±æ•—:", e);
      });
    };

    loadSettings();
    preloadAudios();

  </script>
</body>
</html>
